{"version":3,"file":"server.js","sources":["../../src/server.tsx"],"sourcesContent":["/// <reference types=\"vinxi/types/server\" />\n\nimport pretty from \"pretty\";\nimport { eventHandler } from \"vinxi/http\";\nimport { getManifest } from \"vinxi/manifest\";\nimport { JSX, NoHydration } from \"vynn\";\nimport { renderToString } from \"vynn/server\";\nimport { Router } from \"vynn-router\";\n\nimport { AppProps } from \".\";\nimport { routes } from \"./parse-route\";\n\nexport const renderServer = (App: (props: AppProps) => JSX.Element) => {\n  return eventHandler(async (event) => {\n    // if (event.p)\n    const clientManifest = getManifest(\"client\");\n\n    const rawAssets = await clientManifest.inputs[clientManifest.handler].assets();\n\n    type Assets = ((typeof rawAssets)[number] & { children: string })[];\n    const assets = () => (\n      <>\n        {(rawAssets as Assets).map(({ tag: Tag, attrs, children }) => (\n          <Tag {...attrs}>{children}</Tag>\n        ))}\n      </>\n    );\n\n    const manifest = await (clientManifest.json() as Promise<object>);\n\n    // TODO: Support NoHydration\n    const scripts = () => (\n      <NoHydration>\n        <script html={`window.manifest = ${JSON.stringify(manifest)}`} />\n        <script type=\"module\" src={clientManifest.inputs[clientManifest.handler].output.path} />\n      </NoHydration>\n    );\n\n    const html =\n      \"<!doctype html>\" +\n      renderToString(() => (\n        <App assets={assets} scripts={scripts}>\n          <div id=\"app\">\n            <Router url={event.path} routes={routes} />\n          </div>\n        </App>\n      ));\n\n    event.node.res.setHeader(\"Content-Type\", \"text/html\");\n    if (import.meta.env.PROD) return html;\n\n    return pretty(html);\n  });\n};\n"],"names":["renderServer","App","eventHandler","event","clientManifest","getManifest","rawAssets","inputs","handler","assets","_jsx","_Fragment","children","map","tag","Tag","attrs","manifest","json","scripts","NoHydration","html","JSON","stringify","type","src","output","path","renderToString","id","Router","url","routes","node","res","setHeader","import","PROD","pretty"],"mappings":"iQAYO,MAAMA,EAAgBC,GACpBC,EAAAA,aAAa,MAAOC,GAAU,CAEnC,MAAMC,EAAiBC,cAAY,QAAQ,EAErCC,EAAY,MAAMF,EAAeG,OAAOH,EAAeI,OAAO,EAAEC,SAGhEA,EAASA,IACbC,EAAAA,IAAAC,EAAAA,SAAA,CAAAC,SAAAA,IACIN,EAAqBO,IAAI,CAAC,CAAEC,IAAKC,EAAKC,MAAAA,EAAOJ,SAAAA,CAAS,IACtDF,EAAAA,IAACK,EAAG,CAAA,GAAKC,EAAKJ,SAAAA,IAAGA,CAAQ,CAAM,CAChC,CAAC,CACF,EAGEK,EAAW,MAAOb,EAAec,OAGjCC,EAAUA,IACdT,EAAAA,IAACU,EAAAA,YAAW,CAAAR,SAAAA,IAAA,CAAA,IACVF,EAAAA,IAAA,SAAA,CAAAW,KAAAA,IAAc,qBAAqBC,KAAKC,UAAUN,CAAQ,CAAC,EAAE,CAAG,EAAC,IACjEP,EAAAA,IAAA,SAAA,CAAAc,KAAAA,IAAa,SAAQC,IAAAA,IAAMrB,EAAeG,OAAOH,EAAeI,OAAO,EAAEkB,OAAOC,IAAI,CAAG,CAAC,CAAA,CAC7E,EAGTN,EACJ,kBACAO,EAAAA,eAAe,IACblB,EAAAA,IAACT,EAAG,CAAAQ,OAAAA,IAASA,EAAMU,QAAAA,IAAWA,EAAOP,SAAAA,IACnCF,EAAAA,IAAA,MAAA,CAAAmB,GAAAA,IAAQ,MAAKjB,SAAAA,IACXF,EAAAA,IAACoB,EAAAA,OAAM,CAAAC,IAAAA,IAAM5B,EAAMwB,KAAIK,OAAAA,IAAUA,EAAAA,MAAM,CAAG,CAAC,CACxC,CAAC,CACH,CACN,EAGH,OADA7B,EAAM8B,KAAKC,IAAIC,UAAU,eAAgB,WAAW,EAChDC,SAAgBC,KAAahB,EAE1BiB,EAAOjB,CAAI,CACpB,CAAC"}